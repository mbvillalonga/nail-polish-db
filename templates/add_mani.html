<!DOCTYPE html>
<html lang="en">

<!-- 5/22/25: NOTES TO SELF ABOUT DEVELOPMENT IN COMMENTS -->

<head>
    <title>Add a New Manicure Record</title>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
        {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <h1>Add a New Manicure Record</h1>

    <form method="POST"> 
        <label for="date">Date:</label><br> 
        <input type="date" id="date" name="date" required><br><br><br> 

        <label for="polishes_used">Polish(es) used:</label><br> 
        <input id="polishes_used" name="polishes_used" required><br><br><br>

        <label for="tags">Tags:</label><br>
        <input id="tags" name="tags" placeholder="e.g. shimmer, flakies, jelly"><br><br><br>

        <button type="submit">Add Manicure Record</button><br><br><br>
    </form>
    <a href="{{ url_for('index') }}">Back to Mani Log</a>

    <!-- Tagify for Polishes and Tags -->
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        // POLISHES
        const polishInput = document.getElementById("polishes_used");

        const polishTagify = new Tagify(polishInput, {
            tagTextProp: "label",
            mapValueTo: "value",
            enforceWhitelist: false,
            skipInvalid: true,
            whitelist: [],
            dropdown: {
                enabled: 1,
                maxItems: 10,
                closeOnSelect: true,
                searchKeys: ["label"]
            },
            templates: {
                tag: tagData => `
                    <tag title="${tagData.label}" contenteditable='false' class='tagify__tag'>
                        <x title='remove tag' class='tagify__tag__removeBtn'></x>
                        <div>
                            <span class='tagify__tag-text'>${tagData.label}</span>
                        </div>
                    </tag>`,
                dropdownItem: tagData => `
                    <div class='tagify__dropdown__item' tabindex="0">
                        ${tagData.label}
                    </div>`
            }
        });

        polishTagify.on("input", function (e) {
            const value = e.detail.value;
            if (!value) return;

            fetch(`/search/polishes?q=${encodeURIComponent(value)}`)
                .then(res => res.json())
                .then(data => {
                    polishTagify.whitelist = data;
                    polishTagify.dropdown.show.call(polishTagify, value);
                })
                .catch(err => console.error("Error fetching polish list:", err));
        });

        // TAGS
        const tagInput = document.getElementById("tags");
        const tagTagify = new Tagify(tagInput, {
            dropdown: {
                maxItems: 10,
                enabled: 1,
                closeOnSelect: false
            }
        });

        tagTagify.on("input", e => {
            const value = e.detail.value;
            if (!value) return;

            fetch(`/search/tags?q=${value}`)
                .then(res => res.json())
                .then(data => {
                    tagTagify.settings.whitelist = data;
                    tagTagify.dropdown.show.call(tagTagify, value);
                });
        });
    });
    </script>
</body>
</html>